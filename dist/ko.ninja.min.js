/*! ko.ninja - v0.0.1 - 2013-10-23
* Copyright (c) 2013 ; Licensed  */
!function(a,b){"function"==typeof define&&define.amd?define(["knockout","underscore"],b):"object"==typeof exports?module.exports=b(require("knockout"),require("underscore")):a.ko=b(a.ko,a._,a.$)}(this,function(a,b){var c=function(a,c){var d,e,f=this;return e=a&&b.has(a,"constructor")?a.constructor:function(){return f.apply(this,arguments)},b.extend(e,f,c),d=function(){this.constructor=e},d.prototype=f.prototype,e.prototype=new d,a&&b.extend(e.prototype,a),e.__super__=f.prototype,a.name&&(e.prototype.toString=function(){return a.name}),e},d={on:function(a,b,c){if(!f(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,c,d){if(!f(this,"once",a,[c,d])||!c)return this;var e=this,g=b.once(function(){e.off(a,g),c.apply(this,arguments)});return g._callback=c,this.on(a,g,d)},off:function(a,c,d){var e,g,h,i,j,k,l,m;if(!this._events||!f(this,"off",a,[c,d]))return this;if(!a&&!c&&!d)return this._events={},this;for(i=a?[a]:b.keys(this._events),j=0,k=i.length;k>j;j++)if(a=i[j],h=this._events[a]){if(this._events[a]=e=[],c||d)for(l=0,m=h.length;m>l;l++)g=h[l],(c&&c!==g.callback&&c!==g.callback._callback||d&&d!==g.context)&&e.push(g);e.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=Array.prototype.slice.call(arguments,1);if(!f(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&g(c,b),d&&g(d,arguments),this},stopListening:function(a,b,c){var d=this._listeners;if(!d)return this;var e=!b&&!c;"object"==typeof b&&(c=this),a&&((d={})[a._listenerId]=a);for(var f in d)d[f].off(b,c,this),e&&delete this._listeners[f];return this}},e=/\s+/,f=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var f in c)a[b].apply(a,[f,c[f]].concat(d));return!1}if(e.test(c)){for(var g=c.split(e),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(d));return!1}return!0},g=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},h={listenTo:"on",listenToOnce:"once"};b.each(h,function(a,c){d[c]=function(c,d,e){var f=this._listeners||(this._listeners={}),g=c._listenerId||(c._listenerId=b.uniqueId("l"));return f[g]=c,"object"==typeof d&&(e=this),c[a](d,e,this),this}});var i=function(a){a=a||{},l.call(this,a),this.validation&&m.call(this),this.initialize.call(this,a),this.model&&k.call(this,a)};b.extend(i.prototype,d,{autoSync:!0,fetch:function(a){var c=this,d=this.autoSync;return this.autoSync=!1,this.model.findOne(this[this.idAttribute||"id"]()).done(function(e){b.each(e,function(a,b){c[b](a)}),c.autoSync=d,b.isFunction(a)&&a()})},initialize:function(){}});var j=function(a){a=a||{},b.extend(this,d,{status:"processing",idAttribute:"id",setTransaction:function(a,b){this._transaction=a,this._transactionId=b},invalid:function(){return localStorage?this.name?void 0:{error:!0,message:"This model has no name. Every model needs a name"}:{error:!0,message:"There is no localStorage available in this context"}},done:function(a){var b=this;"processing"!==this.status?(this._transaction&&(this.trigger(this._transaction+"-done"),this._transactionId&&this.trigger(this._transaction+"-"+this._transactionId+"-done"),this.setTransaction()),this.status&&this.status.error?a.call(this,null,this.status):a.call(this,this.status),this.status="processing"):setTimeout(function(){b.done(a)},100)},find:function(a){var b,c=[];if(this.setTransaction("find"),this.invalid())this.status=this.invalid(a);else{for(var d in localStorage)if(~d.indexOf(this.name+"-")){b=!0;for(var e in a)a[e]!==JSON.parse(localStorage[d])[e]&&(b=!1);b&&c.push(JSON.parse(localStorage.getItem(d)))}this.status=c}return this},findOne:function(a){return this.setTransaction("findOne",a),this.status=this.invalid()?this.invalid():JSON.parse(localStorage[this.name+"-"+a]),this},insert:function(a){return this.setTransaction("insert"),a[this.idAttribute]=(new Date).getTime(),this.invalid(a)?this.status=this.invalid(a):(localStorage[this.name+"-"+a.id]=JSON.stringify(a),this.status=a),this},remove:function(a){return this.setTransaction("remove",a),this.invalid()?this.status=this.invalid():(delete localStorage[this.name+"-"+a],this.status=null),this},save:function(a){return a[this.idAttribute]?this.update(a[this.idAttribute],a):this.insert(a)},update:function(a,b){return this.setTransaction("update",a),this.invalid(b)?this.status=this.invalid(b):(b[this.idAttribute]=a,localStorage[this.name+"-"+a]=JSON.stringify(b),this.status=b),this}},a)},k=function(){var a=this,c=function(){var c={};b.each(a.observables,function(b,d){c[d]=a[d]()}),a.model.save(c)},d=b.debounce(c,1);b.each(this.observables,function(b,c){a[c].subscribe(function(){a.autoSync&&d()})})},l=function(c){var d=b.functions(this.observables);d=b.reduce(this.observables,function(a,c,d){return b.isObject(c)&&!b.isArray(c)&&(c.read||c.write)&&a.push(d),a},d),b.each(b.omit(this.observables,d),function(d,e){this[e]=b.isArray(d)?a.isObservable(c[e])?c[e]:a.observableArray((c[e]||d).slice(0)):a.isObservable(c[e])?c[e]:a.observable(c[e]||d),this[e].subscribe(function(a){this.trigger("change:"+e,a)},this)},this),b.each(b.pick(this.observables,d),function(b,c){this[c]=a.computed(this.observables[c],this)},this)},m=function(){};return a.Model=j,a.ViewModel=i,a.Model.extend=a.ViewModel.extend=c,a});